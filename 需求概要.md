# DMP 因子开发智能向导 - 需求概要

## 一、方案概述

### 1.1 项目背景
DMP（Data Management Platform）因子开发智能向导是一个基于 AI 驱动的 DSL（Domain Specific Language）开发工作台。该系统旨在帮助业务人员通过自然语言描述业务需求，自动生成符合规范的 DSL 代码，大幅降低因子开发的技术门槛和开发时间。

### 1.2 核心价值
- **降低技术门槛**：业务人员无需掌握 DSL 语法，通过结构化需求描述即可生成代码
- **提升开发效率**：自动化因子/消息/字段盘点、缺口识别、代码生成等流程，减少人工工作量
- **保证代码质量**：内置语法校验、时序规范检查、业务逻辑验证等机制
- **优化用户体验**：流式代码输出、实时进度反馈、可视化交互界面

### 1.3 设计理念
- **向导式流程**：将复杂的因子开发过程拆分为4个清晰的步骤
- **上下文感知**：实时显示当前上下文信息，提供智能建议
- **渐进式交互**：支持逐步完善需求，每个步骤都有明确的输入输出
- **即时反馈**：每个操作都有即时的视觉反馈和状态提示

## 二、功能清单

### 2.1 第一步：需求结构化

#### 2.1.1 核心功能
- **因子名称输入**：支持输入业务因子的名称
- **三段式需求描述**：
- 用户可以手工输入，也可以上传文件上传，通过AI识别，需包含以下DSL代码必备内容
  - **第一段 - 触发条件（相关性）**：描述何时触发计算
  - **第二段 - 计算逻辑（公式/参数）**：描述具体的计算公式和业务规则
  - **第三段 - 下钻/导出定义**：描述需要展示的维度和明细
- **智能助手提示**：提供需求描述的结构化指导

#### 2.1.2 界面特性
- 响应式两列布局（宽屏优化）
- 表单字段标签化，清晰标识三段式结构
- 计算逻辑区域使用等宽字体，便于输入代码片段

### 2.2 第二步：因子盘点（含缺口定义）

#### 2.2.1 核心功能
- **AI 因子盘点**：
  - 自动检索 DMP 元数据知识库
  - 识别已存在的元因子和缺失的逻辑
  - 识别已存在的消息和缺失的消息
  - 识别已存在的字段和缺失的字段
  - 显示因子/消息/字段状态（已存在/缺失）
- **内联展开式缺口定义**：
  - 缺失因子行可点击展开定义区域
  - 缺失消息行可点击展开定义区域
  - 缺失字段行可点击展开定义区域
  - 显示 AI 建议的 DSL 代码片段或定义
  - 支持确认采纳或修改定义
  - 支持同时处理多个缺失项（因子、消息、字段，共2-3个）
- **进度控制**：
  - 实时显示已定义/总数进度（包含因子、消息、字段）
  - 所有缺失项（因子、消息、字段）定义完成后才允许进入下一步

#### 2.2.2 界面特性
- 表格展示盘点结果列表，包含：识别实体、对应ID、类型（因子/消息/字段）、状态、说明、操作
- 缺失项（因子/消息/字段）行使用红色背景高亮
- 已定义项行使用绿色背景标识
- 支持按类型分组显示（因子、消息、字段）
- 展开定义区域包含：AI建议说明、DSL代码预览或定义内容、确认按钮
- 底部进度提示栏，显示定义进度和完成状态（汇总所有类型的缺失项）

### 2.3 第三步：DSL 合成

#### 2.3.1 核心功能
- **流式代码输出**：
  - 代码逐字符显示，模拟打字机效果
  - 输出速度：每15毫秒一个字符
  - 显示"正在生成..."提示动画
- **代码编辑器**：
  - 类终端风格的代码编辑器
  - 语法高亮显示
  - 支持重新生成功能
- **状态标识**：
  - 显示"三段式结构"和"时序校验通过"标识

#### 2.3.2 界面特性
- 深色主题代码编辑器（slate-900背景）
- 顶部工具栏显示文件名和状态标识
- 流式输出过程中显示生成进度提示
- 最小高度500px，确保代码完整显示

### 2.4 第四步：双向验收

#### 2.4.1 核心功能
- **代码-业务翻译**：
  - AI 自动生成业务逻辑说明
  - 将 DSL 代码翻译为自然语言描述
  - 解释触发条件、计算逻辑、展示输出
- **语法风控报告**：
  - 三段式结构完整性检查
  - 时序函数作用域验证
  - 可变因子位置校验
- **仿真测试建议**：
  - 推荐测试数据组合
  - 覆盖不同业务分支场景
- **提交并发布**：
  - 提交过程状态反馈（提交中/提交成功）
  - 提交成功后显示成功提示
  - 显示后续处理时间预估

#### 2.4.2 界面特性
- 成功提示使用渐变背景和动画效果
- 两列布局展示风控报告和测试建议
- 提交按钮状态变化：正常 → 提交中（旋转动画）→ 提交成功（弹跳动画）

### 2.5 通用功能

#### 2.5.1 步骤导航
- 顶部步骤指示器，显示当前进度
- 已完成步骤显示对勾图标
- 当前步骤高亮显示
- 步骤间连接线显示完成状态

#### 2.5.2 上下文感知侧边栏
- 显示当前业务域信息
- 显示已加载元数据数量
- 实时显示依赖检查状态
- 提供参考 DSL 函数示例

#### 2.5.3 响应式布局
- 主容器最大宽度：1280px（max-w-7xl）
- 侧边栏宽度：384px（w-96）
- 适配1920px宽屏显示
- 优化横向空间利用

## 三、用户关键流程

### 3.1 完整流程概览

```
需求结构化 → 因子盘点（含缺口定义） → DSL 合成 → 双向验收 → 提交发布
```

### 3.2 详细流程步骤

#### 步骤1：需求结构化
1. 用户输入因子名称
2. 填写触发条件描述（第一段）
3. 填写计算逻辑描述（第二段）
4. 填写下钻/导出定义（第三段）
5. 点击"下一步"按钮
6. 系统进行需求分析（显示加载状态）

#### 步骤2：因子盘点（含缺口定义）
1. 系统展示盘点结果
   - 显示已存在的元因子、消息、字段列表
   - 高亮显示缺失的因子、消息、字段
   - 支持按类型（因子/消息/字段）分组查看
2. 用户处理缺失项（如果有）
   - 点击缺失项（因子/消息/字段）行或展开图标
   - 查看 AI 建议的 DSL 代码或定义内容
   - 确认采纳或修改定义
   - 重复处理所有缺失项（因子、消息、字段）
3. 系统显示定义进度
   - 实时更新"已定义 X/总数"（汇总所有类型的缺失项）
   - 全部完成后显示"可以继续下一步"
4. 点击"下一步"进入 DSL 合成

#### 步骤3：DSL 合成
1. 系统开始流式输出 DSL 代码
   - 代码逐字符显示
   - 显示"正在生成..."提示
2. 代码生成完成后
   - 用户可以查看完整代码
   - 可以点击"重新生成"重新生成代码
3. 点击"下一步"进入验收

#### 步骤4：双向验收
1. 系统展示代码业务翻译
   - 自动生成的业务逻辑说明
2. 用户查看风控报告
   - 检查语法校验结果
   - 查看测试建议
3. 用户确认无误后
   - 点击"提交并发布"按钮
4. 系统处理提交
   - 显示"提交中..."状态（旋转动画）
   - 1.5秒后显示"提交成功！"（弹跳动画）
   - 显示成功提示信息

### 3.3 关键交互点

#### 3.3.1 缺失项处理流程（因子/消息/字段）
```
点击缺失项行（因子/消息/字段）
  → 展开定义区域 
    → 查看AI建议代码或定义内容
      → 确认采纳 
        → 自动收起 
          → 状态更新为"已定义"
```

#### 3.3.2 流式代码输出流程
```
进入DSL合成步骤 
  → 自动触发流式输出 
    → 代码逐字符显示（15ms/字符）
      → 显示生成进度 
        → 输出完成
```

#### 3.3.3 提交发布流程
```
点击提交按钮 
  → 显示提交中状态 
    → 1.5秒后显示成功 
      → 显示成功提示卡片
```

## 四、原型设计

### 4.1 整体布局

#### 4.1.1 页面结构
```
┌─────────────────────────────────────────────────────────┐
│ Header: 标题 + 控制台/知识库助手按钮                      │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  步骤指示器（4个步骤，带连接线）                          │
│                                                           │
│  ┌─────────────────────────┬──────────────────────┐    │
│  │                         │                      │    │
│  │   主内容区域            │   侧边栏             │    │
│  │   (flex-1)              │   (w-96)             │    │
│  │                         │                      │    │
│  │   - 步骤内容            │   - 当前上下文        │    │
│  │   - 表单/表格/代码      │   - 参考DSL函数      │    │
│  │                         │                      │    │
│  └─────────────────────────┴──────────────────────┘    │
│                                                           │
│  底部操作栏：上一步 / 下一步/提交                         │
└─────────────────────────────────────────────────────────┘
```

#### 4.1.2 尺寸规格
- **主容器**：最大宽度 1280px（max-w-7xl）
- **主内容区**：padding 32px（p-8）
- **侧边栏**：宽度 384px（w-96），padding 24px（p-6）
- **Header**：padding 水平32px，垂直20px（px-8 py-5）

### 4.2 视觉设计

#### 4.2.1 色彩系统
- **主色调**：蓝色（blue-600）用于主要操作和激活状态
- **成功色**：绿色（green-600）用于成功状态和已存在项（因子/消息/字段）
- **警告色**：红色（red-50/100）用于缺失项（因子/消息/字段）和警告提示
- **中性色**：灰色系（slate）用于背景和文本

#### 4.2.2 组件样式
- **卡片**：白色背景，圆角（rounded-xl），阴影（shadow-sm）
- **按钮**：
  - 主要按钮：蓝色背景，白色文字，hover加深
  - 成功按钮：绿色背景，白色文字
  - 图标按钮：文字色，hover背景色
- **表格**：边框分割，hover行高亮
- **代码编辑器**：深色主题（slate-900），绿色代码文字

#### 4.2.3 动画效果
- **淡入动画**：页面切换时使用（animate-fadeIn）
- **流式输出**：代码逐字符显示（15ms间隔）
- **旋转动画**：加载状态（animate-spin）
- **弹跳动画**：成功状态（animate-bounce）
- **缩放动画**：成功图标进入（animate-scaleIn）
- **脉冲动画**：进度提示（animate-pulse）

### 4.3 交互设计

#### 4.3.1 状态反馈
- **加载状态**：按钮显示旋转图标 + "处理中..."
- **禁用状态**：按钮半透明，鼠标禁用样式
- **成功状态**：绿色背景，对勾图标，弹跳动画
- **进度提示**：实时显示进度条和百分比

#### 4.3.2 展开/收起交互
- **缺失项行（因子/消息/字段）**：点击整行或图标展开
- **展开区域**：在表格内嵌入，使用手风琴效果
- **定义完成**：自动收起，状态更新为绿色

#### 4.3.3 流式输出交互
- **自动触发**：进入DSL合成步骤时自动开始
- **进度提示**：右下角显示"正在生成..."和脉冲动画
- **重新生成**：点击按钮重置并重新开始流式输出

### 4.4 响应式设计

#### 4.4.1 宽屏优化（1920px）
- 主容器使用 max-w-7xl（1280px）
- 第一步使用两列布局（lg:grid-cols-2）
- 表格和卡片增加内边距
- 侧边栏宽度增加到384px

#### 4.4.2 移动端适配
- 侧边栏在移动端隐藏（hidden lg:flex）
- 表格在小屏幕可横向滚动
- 两列布局在小屏幕自动变为单列

### 4.5 关键界面元素

#### 4.5.1 步骤指示器
- 圆形数字/对勾图标
- 步骤标题
- 连接线显示完成状态
- 当前步骤放大效果（scale-110）

#### 4.5.2 盘点结果列表表格
- 表头：识别实体、对应ID、类型（因子/消息/字段）、状态、说明、操作
- 支持按类型分组显示（因子、消息、字段）
- 已存在项（因子/消息/字段）：正常行样式
- 缺失项（因子/消息/字段）：红色背景，可点击展开
- 已定义项：绿色背景
- 操作列：图标按钮（ChevronRight/ChevronDown）

#### 4.5.3 代码编辑器
- 类终端风格：深色背景，绿色文字
- 顶部工具栏：红黄绿圆点 + 文件名
- 代码区域：等宽字体，可滚动
- 生成提示：右下角浮动提示

#### 4.5.4 成功提示卡片
- 渐变背景（green-50 to emerald-50）
- 大号成功图标（带动画）
- 成功消息和后续提示
- 淡入和缩放动画效果

## 五、技术实现要点

### 5.1 核心技术栈
- **前端框架**：React 18
- **构建工具**：Vite
- **样式方案**：Tailwind CSS
- **图标库**：Lucide React
- **状态管理**：React Hooks（useState, useRef, useEffect）

### 5.2 关键实现
- **流式输出**：使用 setInterval 实现逐字符显示
- **状态管理**：使用对象记录多个缺失项（因子/消息/字段）的展开和定义状态
- **类型识别**：支持识别和管理三种类型：因子（Factor）、消息（Message）、字段（Field）
- **进度控制**：动态计算已定义项数量（汇总因子、消息、字段），控制按钮状态
- **分组展示**：支持按类型分组显示盘点结果，提升可读性
- **动画效果**：使用 Tailwind 动画类和自定义 CSS 动画

### 5.3 性能优化
- 使用 useRef 避免不必要的重渲染
- 流式输出使用定时器管理，及时清理避免内存泄漏
- 条件渲染减少不必要的 DOM 节点

## 六、后续优化方向

### 6.1 功能增强
- 支持保存草稿功能
- 支持导入/导出需求模板
- 支持历史记录查看
- 支持多人协作编辑

### 6.2 体验优化
- 添加键盘快捷键支持
- 优化移动端交互体验
- 增加更多动画过渡效果
- 支持主题切换（深色/浅色）

### 6.3 智能化提升
- 更精准的因子识别
- 更智能的代码建议
- 支持自定义 DSL 模板
- 集成更多业务规则校验

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护人员**：开发团队


